<div class="docs">

  <%= cache ["downloads_table", product, current_user, I18n.locale] do %>
    <% if can?(:manage, product) %>
      <div class="panel" id="upload-site-element-container">
        <p>Use this form to upload a NEW file. If you'd like to upload a new version of an
        existing file, hover over that item in the table below and click the <%= fa_icon "edit" %>
        edit icon if available.</p>

        <div class="callout panel">
          <%= s3_uploader_form callback_url: upload_admin_site_elements_url,
              id: "s3_uploader",
              callback_param: "direct_upload_url",
              acl: "public-read",
              expiration: 24.hours.from_now.utc.iso8601,
              max_file_size: 900.megabytes do %>
            <p>Navigate to the file on your computer or drag and drop it below before filling out the rest of the form:</p>
            <div class="text-center">
              <%= file_field_tag :file %>
            </div>

            <div id="site_element_progress">
              <div id="uploads_container"></div>
              <script id="template-upload" type="text/x-tmpl">
              <div id="upload_{%=o.unique_id%}" class="upload">
                {%=o.name%}
                <div class="progress success progress-striped active"><span class="bar meter" style="width: 0%"></span></div>
                <div id="upload_instruct" class="hint">Wait for the upload to complete before submitting the form.</div>
              </div>
              </script>
            </div>

          <% end %>
        </div>

        <%= simple_form_for [:admin, @site_element] do |f| %>
          <input type="hidden" name="return_to" value="<%= product_path(product) %>">
          <%= f.input :direct_upload_url, as: :hidden %>
          <%= f.input :name, label: "Name (as it will appear for site users)" %>
          <div class="row">
            <div class="medium-6 small-12 columns">
              <%= f.input :language, collection: HarmanSignalProcessingWebsite::Application.config.document_languages %>
            </div>
            <div class="medium-6 small-12 columns">
              <%= f.input :version %>
            </div>
          </div>

          <div class="row">
            <div class="large-6 columns">
              <%= f.input :resource_type,
                label: "Category",
                required: true,
                collection: (website.brand.name == "Martin") ? SiteElement.resource_types(brand_id: website.brand_id) : SiteElement.resource_types %>
            </div>
            <div class="large-6 columns">
              <%= f.association :access_level,
                label_method: :long_name,
                hint: "(optional--leave blank to allow all access)"%>
            </div>
          </div>

          <%= f.association :products,
            label: "Related Products",
            collection: website.brand.products,
            include_blank: true,
            input_html: { class: 'chosen-select' } %>

          <br/>
          <%= f.input :is_document, label: "Show this item as a document on the product page." %>
          <%= f.input :is_software, label: "Show this item as software on the product page." %>
          <%= f.input :show_on_public_site, label: "Also show on the main downloads page in the support area of the site." %>

          <%= f.submit 'Save File', class: "small button" %>
        <% end %>
      </div>
    <% end %>
    <table style="width: 100%">
      <thead>
        <tr>
          <td><!--Filename-->&nbsp;</td>
          <td class="hide-for-small">Version</td>
          <td class="hide-for-small">Language</td>
          <td>Size</td>
          <td class="hide-for-small">Uploaded</td>
        </tr>
      </thead>
      <tbody>
      <% if product.current_and_recently_expired_promotions.where.not(promo_form_file_name: [nil, '']).length > 0 %>
        <tr>
          <td colspan="5">
            <%= image_tag("icons/pdf_17.png", style: "vertical-align: middle") %>
            <%= link_to(t('product_page.rebate_forms'), promotions_path) %>
          </td>
        </tr>
      <% end %>

      <% product.safety_documents.includes(:product).each do |product_document| %>
        <%= render_partial 'shared/download_table_row', item: product_document %>
      <% end %>

      <% product.nonsafety_documents.includes(:product).each do |product_document| %>
        <%= render_partial 'shared/download_table_row', item: product_document %>
      <% end %>

      <% (product.all_related_downloads(I18n.locale.to_s, website)).group_by(&:resource_type).sort_by{|r,i| download_group_sort_order(r)}.each do |resource_type, site_elements| %>
        <%= downloads_header_row(resource_type, site_elements, columns: 5) %>
        <% site_elements.each do |site_element| %>
          <%= render_partial 'shared/download_table_row', item: site_element %>
        <% end %>
      <% end %>

      </tbody>
    </table>
  <% end %>
  <p><i>If any of the links above result in strange characters in your browser, please right-click the file
    to save it to your computer.</i></p>
</div>
