# New DOD site
upstream dod_balancer {
    server 10.10.23.86:8909;
    server 10.10.23.15:8909 weight=4;
}

server {
    listen 10.10.23.86:8909;
    server_name dod_node_1;
    root /var/www/hmg/hsp_websites/current/public;
    passenger_enabled on;
}

server {
    listen 10.10.23.88:80;
    server_name www.dod.com dod.com;
    include "/etc/nginx/security.conf";
    root /var/www/hmg/hsp_websites/current/public;
#    passenger_enabled on;
    access_log  /var/log/nginx/dod-access.log;
    error_log /var/log/nginx/dod-error.log;
    sendfile on;

    location / {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      proxy_pass http://dod_balancer;
    }

    location ~ ^/(assets)/ {
      root /var/www/hmg/hsp_websites/current/public;
      gzip_static on;
      gzip_http_version 1.0;
      expires      365d;
      add_header Cache-Control public;
      add_header   Last-Modified "";
      add_header ETag "";
      break;
    }
    location ~ ^/system\/wares/ {
      internal;
      root /var/www/hmg/hsp_websites/shared;
      gzip_static on;
      gzip_http_version 1.0;
      expires      365d;
      add_header Cache-Control public;
      add_header   Last-Modified "";
      add_header ETag "";
      break;
    }
    location ~ ^/(system)/ {
      root /var/www/hmg/hsp_websites/shared;
      gzip_static on;
      gzip_http_version 1.0;
      expires      90d;
      add_header Cache-Control public;
      add_header   Last-Modified "";
      add_header ETag "";
      break;
    }
    location ~ ^/(swfs)/ {
      root /var/www/hmg/hsp_websites/current/public;
      gzip_static on;
      gzip_http_version 1.0;
      expires      365d;
      add_header Cache-Control public;
      add_header   Last-Modified "";
      add_header ETag "";
      break;
    }
    location ~ ^/system\/marketing_attachments/ {
      internal;
    }
    # Get rid of lame iframe params
    if ($args ~ (.*)width=[^&]*(.*)) {
      set $args $1$2;
    }
    if ($args ~ (.*)height=[^&]*(.*)) {
      set $args $1$2;
    }
    if ($args ~ (.*)iframe=[^&]*(.*)) {
      set $args $1$2;
    }
    location = /favicon.ico {
      alias /var/www/hmg/hsp_websites/current/public/dod.ico;
    }

    location /mailers/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.174;
    }
    location /static/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.174;
    }
    location /toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.176;
    }
    location /Toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.176;
    }
    
    rewrite ^/supportpages\/faq.*$ /en-US/dod-faqs permanent;
    rewrite ^/supportpages\/PowerSupply.*$ /en-US/dod-power-supplies permanent;
    rewrite ^/supportpages.*$ /en-US/support permanent;

    rewrite ^/fxpedals\/fx102.*$ /en-US/products/fx102 permanent;
    rewrite ^/fxpedals\/fx25B.*$ /en-US/products/fx25b permanent;
    rewrite ^/fxpedals\/fx84.*$ /en-US/products/fx84 permanent;
    rewrite ^/fxpedals\/fx91.*$ /en-US/products/fx91 permanent;
    rewrite ^/fxpedals\/fx66.*$ /en-US/products/fx66 permanent;
    rewrite ^/fxpedals\/fx22.*$ /en-US/products/fx22 permanent;
    rewrite ^/fxpedals\/fx20C.*$ /en-US/products/fx20c permanent;
    rewrite ^/fxpedals\/fx55.*$ /en-US/products/fx55 permanent;
    rewrite ^/fxpedals\/wrath.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/power.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/country.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/love.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/allpedals.*$ /en-US/product_families/effect-pedals permanent;
    
    rewrite ^/processors\/sprocessors.*$ /en-US/products permanent;
    rewrite ^/processors\/sr460h.*$ /en-US/products/sr460h permanent;
    rewrite ^/processors\/sr410.*$ /en-US/products/sr410 permanent;
    rewrite ^/processors\/sr866.*$ /en-US/products/sr866 permanent;
    rewrite ^/processors\/sr606.*$ /en-US/products/sr606 permanent;

    rewrite ^/graphiceqs\/graphiceqs.*$ /en-US/product_families/equalizers--2 permanent;
    rewrite ^/graphiceqs\/sr231.*$ /en-US/products/sr231qxlr permanent;
    rewrite ^/graphiceqs\/sr430.*$ /en-US/products/sr430qxlr permanent;
    rewrite ^/graphiceqs\/sr431.*$ /en-US/products/sr431qxlr permanent;
    rewrite ^/graphiceqs\/sr830.*$ /en-US/products/sr830qxlr permanent;
    rewrite ^/graphiceqs\/sr831.*$ /en-US/products/sr831qxlr permanent;

    rewrite ^/crossover\/crossover.*$ /en-US/product_families/crossover permanent;
    rewrite ^/crossover\/sr835.*$ /en-US/products/sr835 permanent;
    rewrite ^/crossover\/sr823.*$ /en-US/products/sr823 permanent;
    rewrite ^/crossover\/sr834.*$ /en-US/products/sr834 permanent;
    
    rewrite ^/accessories.*$ /en-US/product_families/audio-accessories permanent;

    rewrite ^/doddealers\/service.*$ /en-US/support permanent;
    rewrite ^/doddealers.*$ /en-US/where_to_buy permanent;
    rewrite ^/cgi-bin\/intdealer.*$ /en-US/international_distributors permanent;
    rewrite ^/cgi-bin\/register.*$ /en-US/support/warranty_registration permanent;

# Weird stuff the search engines keep trying to access triggering rails errors:

    location ~* /timberland {
      error_page 404 /404.html;
    }
    location ~* /159 {
      error_page 404 /404.html;
    }
    location ~* /ix35 {
      error_page 404 /404.html;
    }
    location ~* /w999 {
      error_page 404 /404.html;
    }

#    location /cgi-bin/ {
#      proxy_pass http://10.10.69.174;
#    }
}


