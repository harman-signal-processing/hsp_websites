server {
    listen 80;
    server_name www.dod.com;
    server_name dod.com;
    include "/etc/nginx/security.conf";
    return 301 https://dod.com$request_uri;
}
server {
    listen 80;
    server_name dod.hprosandbox.com;
    include "/etc/nginx/security.conf";
    return 301 https://dod.hprosandbox.com$request_uri;
}

server {
    listen 443 ssl;
    server_name www.dod.com;
    include "/etc/nginx/security.conf";
    #include "/etc/nginx/common.conf";
    ssl_certificate     /etc/letsencrypt/live/dod.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dod.com/privkey.pem;

    # Enable OCSP stapling (http://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox)
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/dod.com/fullchain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    return 301 https://dod.com$request_uri;
}

server {
    listen 443 ssl;
    server_name dod.com dod.hprosandbox.com;
    include "/etc/nginx/security.conf";
    root /var/www/brandsites/current/public;
    access_log  /var/log/nginx/dod-access.log;
    error_log /var/log/nginx/dod-error.log;
    passenger_enabled on;
    sendfile on;

    ssl_certificate     /etc/letsencrypt/live/dod.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dod.com/privkey.pem;

    # Enable OCSP stapling (http://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox)
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/dod.com/fullchain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

#    include "/etc/nginx/common.conf";
# Common to most all the rails sites
add_header X-Frame-Options "SAMEORIGIN";
passenger_enabled on;
passenger_friendly_error_pages off;
proxy_cache hsp;

location / {
  if (-f /var/www/brandsites/shared/config/maintenance.txt) {
      return 503;
  }

  # When the request goes through the Rackspace load balancer, it adds the
  # http_x_forwarded_proto header. Since we're trying to only answer on https
  # for most requests, this will redirect the request to https if Rackspace
  # tells us the request came through with http.
  #
  # This worked well until Jan 30, 2018. Then I had to start doing SSL termination
  # in NGINX instead of at the Rackspace load balancer.
  #
  #if ($http_x_forwarded_proto = "http") {
  #  return 301 https://$server_name$request_uri;
  #}
  #
  #expires 15m;
  #add_header Cache-Control "public";
  if ($request_uri ~* ".(jpg|jpeg|gif|gz|flv|wmv|avi|css|swf|png|ico|mpeg|mpg|mp3|mp4|js)(\?v=[0-9.]+)?$") {
    expires 7d;
    access_log off;
    break;
  }
  passenger_enabled on;
  passenger_friendly_error_pages off;
}

location ~ \/rss$ {
  rewrite ^(.*)\/rss$ $1/rss.xml permanent;
}

location ~ sitemap {
  passenger_enabled on;
  expires 1d;
  add_header Cache-Control "public";
  proxy_ignore_headers Set-Cookie;
  proxy_hide_header Set-Cookie;
}
#location / {
#  proxy_set_header X-Forwarded-Host $host;
#  proxy_set_header X-Forwarded-Server $host;
#  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#  proxy_set_header Host $host;
#  proxy_pass http://hsp_backend;
#}

location ~ ^/(assets)/ {
  root /var/www/brandsites/current/public;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/system\/wares/ {
  internal;
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/protected_softwares/ {
  internal;
  root /var/www/brandsites/protected;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/system\/marketing_files/ {
  internal;
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/(system)/ {
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      30d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/(swfs)/ {
  root /var/www/brandsites/current/public;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}

# cn redirect to zh
location /cn {
  rewrite ^ /zh permanent;
}

# Get rid of lame iframe params
if ($args ~ (.*)width=[^&]*(.*)) {
  set $args $1$2;
}
if ($args ~ (.*)height=[^&]*(.*)) {
  set $args $1$2;
}
if ($args ~ (.*)iframe=[^&]*(.*)) {
  set $args $1$2;
}

error_page 503 @maintenance;
location @maintenance {
   rewrite ^(.*)$ /503.html break;
}

    location = /favicon.ico {
      alias /var/www/brandsites/current/public/dod.ico;
    }
    location = /logo.png {
      proxy_pass http://d92e2d4def4ad9ded9c8-e33f4b22204b900070d3db62d0c33a2c.r80.cf2.rackcdn.com/dod.png;
    }
    location /mailers/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://www2.digitech.com;
      proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /static/ {
      rewrite ^/static/(.*)$ /static/dod$1 break;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://www2.digitech.com;
      proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://www2.digitech.com;
      proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /Toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://www2.digitech.com;
      proxy_redirect   http://www2.digitech.com/    http://$host/;
    }

    rewrite ^/supportpages\/faq.*$ /en-US/dod-faqs permanent;
    rewrite ^/supportpages\/PowerSupply.*$ /en-US/dod-power-supplies permanent;
    rewrite ^/supportpages.*$ /en-US/support permanent;

    rewrite ^/fxpedals\/fx102.*$ /en-US/products/fx102 permanent;
    rewrite ^/fxpedals\/fx25B.*$ /en-US/products/fx25b permanent;
    rewrite ^/fxpedals\/fx84.*$ /en-US/products/fx84 permanent;
    rewrite ^/fxpedals\/fx91.*$ /en-US/products/fx91 permanent;
    rewrite ^/fxpedals\/fx66.*$ /en-US/products/fx66 permanent;
    rewrite ^/fxpedals\/fx22.*$ /en-US/products/fx22 permanent;
    rewrite ^/fxpedals\/fx20C.*$ /en-US/products/fx20c permanent;
    rewrite ^/fxpedals\/fx55.*$ /en-US/products/fx55 permanent;
    rewrite ^/fxpedals\/wrath.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/power.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/country.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/love.*$ /en-US/product_families/effect-pedals permanent;
    rewrite ^/fxpedals\/allpedals.*$ /en-US/product_families/effect-pedals permanent;

    rewrite ^/processors\/sprocessors.*$ /en-US/products permanent;
    rewrite ^/processors\/sr460h.*$ /en-US/products/sr460h permanent;
    rewrite ^/processors\/sr410.*$ /en-US/products/sr410 permanent;
    rewrite ^/processors\/sr866.*$ /en-US/products/sr866 permanent;
    rewrite ^/processors\/sr606.*$ /en-US/products/sr606 permanent;

    rewrite ^/graphiceqs\/graphiceqs.*$ /en-US/product_families/equalizers--2 permanent;
    rewrite ^/graphiceqs\/sr231.*$ /en-US/products/sr231qxlr permanent;
    rewrite ^/graphiceqs\/sr430.*$ /en-US/products/sr430qxlr permanent;
    rewrite ^/graphiceqs\/sr431.*$ /en-US/products/sr431qxlr permanent;
    rewrite ^/graphiceqs\/sr830.*$ /en-US/products/sr830qxlr permanent;
    rewrite ^/graphiceqs\/sr831.*$ /en-US/products/sr831qxlr permanent;

    rewrite ^/crossover\/crossover.*$ /en-US/product_families/crossover permanent;
    rewrite ^/crossover\/sr835.*$ /en-US/products/sr835 permanent;
    rewrite ^/crossover\/sr823.*$ /en-US/products/sr823 permanent;
    rewrite ^/crossover\/sr834.*$ /en-US/products/sr834 permanent;

    rewrite ^/accessories.*$ /en-US/product_families/audio-accessories permanent;

    rewrite ^/doddealers\/service.*$ /en-US/support permanent;
    rewrite ^/doddealers.*$ /en-US/where_to_buy permanent;
    rewrite ^/cgi-bin\/intdealer.*$ /en-US/international_distributors permanent;
    rewrite ^/cgi-bin\/register.*$ /en-US/support/warranty_registration permanent;

}


