server {
    listen 80;
    server_name www.digitech.com *.digitech.com;
    server_name digitech.com;
    include "/etc/nginx/security.conf";

    location / {
      return 301 https://digitech.com$request_uri;
    }

    # IMPORTANT
    # Do not forward this location to https. We have several products
    # which rely on this path to check for software updates. The updater
    # does not follow any kind of redirects or rewrites.
    location /updater {
      alias /var/www/brandsites/static/updater/;
    }
}

server {
    listen 443 ssl;
    server_name www.digitech.com;
    include "/etc/nginx/security.conf";
    include "/etc/nginx/common.conf";
    return 301 https://digitech.com$request_uri;
}

server {
    listen 443 ssl;
    server_name digitech.com; # "" -;
    include "/etc/nginx/security.conf";
    root /var/www/brandsites/current/public;
    access_log  /var/log/nginx/digitech-access.log;
    error_log /var/log/nginx/digitech-error.log;
    passenger_enabled on;
    sendfile on;

    location = /favicon.ico {
      alias /var/www/brandsites/current/public/digitech.ico;
    }
    location = /logo.png {
      proxy_pass http://d92e2d4def4ad9ded9c8-e33f4b22204b900070d3db62d0c33a2c.r80.cf2.rackcdn.com/digitech.png;
    }

    ssl_certificate     /etc/letsencrypt/live/digitech.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/digitech.com/privkey.pem;

    # Enable OCSP stapling (http://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox)
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/digitech.com/fullchain.pem;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

#    include "/etc/nginx/common.conf";
# Common to most all the rails sites
add_header X-Frame-Options "SAMEORIGIN";
passenger_enabled on;
passenger_friendly_error_pages off;
proxy_cache hsp;

location / {
  if (-f /var/www/brandsites/shared/config/maintenance.txt) {
      return 503;
  }

  # When the request goes through the Rackspace load balancer, it adds the
  # http_x_forwarded_proto header. Since we're trying to only answer on https
  # for most requests, this will redirect the request to https if Rackspace
  # tells us the request came through with http.
  #
  # This worked well until Jan 30, 2018. Then I had to start doing SSL termination
  # in NGINX instead of at the Rackspace load balancer.
  #
  #if ($http_x_forwarded_proto = "http") {
  #  return 301 https://$server_name$request_uri;
  #}
  #
  #expires 15m;
  #add_header Cache-Control "public";
  if ($request_uri ~* ".(jpg|jpeg|gif|gz|flv|wmv|avi|css|swf|png|ico|mpeg|mpg|mp3|mp4|js)(\?v=[0-9.]+)?$") {
    expires 7d;
    access_log off;
    break;
  }
  passenger_enabled on;
  passenger_friendly_error_pages off;
}

location ~ \/rss$ {
  rewrite ^(.*)\/rss$ $1/rss.xml permanent;
}

location ~ sitemap {
  passenger_enabled on;
  expires 1d;
  add_header Cache-Control "public";
  proxy_ignore_headers Set-Cookie;
  proxy_hide_header Set-Cookie;
}
#location / {
#  proxy_set_header X-Forwarded-Host $host;
#  proxy_set_header X-Forwarded-Server $host;
#  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#  proxy_set_header Host $host;
#  proxy_pass http://hsp_backend;
#}

location ~ ^/(assets)/ {
  root /var/www/brandsites/current/public;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/system\/wares/ {
  internal;
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/protected_softwares/ {
  internal;
  root /var/www/brandsites/protected;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/system\/marketing_files/ {
  internal;
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/(system)/ {
  root /var/www/brandsites/shared;
  gzip_static on;
  gzip_http_version 1.0;
  expires      30d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}
location ~ ^/(swfs)/ {
  root /var/www/brandsites/current/public;
  gzip_static on;
  gzip_http_version 1.0;
  expires      365d;
  add_header Cache-Control public;
  add_header   Last-Modified "";
  add_header ETag "";
  break;
}

# cn redirect to zh
location /cn {
  rewrite ^ /zh permanent;
}

# Get rid of lame iframe params
if ($args ~ (.*)width=[^&]*(.*)) {
  set $args $1$2;
}
if ($args ~ (.*)height=[^&]*(.*)) {
  set $args $1$2;
}
if ($args ~ (.*)iframe=[^&]*(.*)) {
  set $args $1$2;
}

error_page 503 @maintenance;
location @maintenance {
   rewrite ^(.*)$ /503.html break;
}
    location /mailers/ {
      return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /static/ {
      return 301 http://www2.digitech.com$request_uri;
      rewrite ^/static/(.*)$ /static/digitech$1 break;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /updater {
      ##return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
      alias /var/www/brandsites/static/updater/;
    }
    location ~ (?i)^/jamman_mailers {
      return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location ~ (?i)^/soundcomm {
      return 301 http://www2.digitech.com$request_uri;
#      rewrite ^/soundcomm/(.*)$ /$1 break;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location /cgi-bin/ {
      return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location ~ (?i)^/toolkit {
      return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }
    location ~ (?i)^/webhelp/ {
      return 301 http://www2.digitech.com$request_uri;
      #proxy_set_header X-Forwarded-Host $host;
      #proxy_set_header X-Forwarded-Server $host;
      #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      #proxy_pass http://www2.digitech.com;
      #proxy_redirect   http://www2.digitech.com/    http://$host/;
    }

    rewrite ^/en-US/products/snake_charmer_tremolo /en-US/introducing/snake-charmer permanent;
    rewrite ^/en-US/introducing/snake_charmer_tremolo /en-US/introducing/snake-charmer permanent;
    rewrite ^/getamped$ http://land.digitech.com/pages/get-amped permanent;
    rewrite ^/istomp$ /en-US/products/istomp permanent;
    rewrite ^/stompshop$ /en-US/softwares/stomp-shop permanent;
    rewrite ^/stomp-shop$ /en-US/softwares/stomp-shop permanent;
    rewrite ^/index.*$ /en-US permanent;
    rewrite ^/vocalist.*$ http://www.vocalistpro.com permanent;
    rewrite ^/hardwire.*$ /en-US/product_families/hardwire-extreme-performance-pedals permanent;
    rewrite ^/jamplay.*$  http://www.jamplay.com/trial/digitech permanent;
    rewrite ^/multieffects.*$ /en-US/product_families/multi-effects permanent;
    rewrite ^/pedals.*$ /en-US/product_families/pedals permanent;
    rewrite ^/specialtypedals.*$ /en-US/product_families/pedals permanent;
    rewrite ^/bass.*$ /en-US/product_families/bass-multi-effects permanent;
    rewrite ^/products\/Multi\-Effects\/GSP1101.*$ /en-US/products/gsp1101 permanent;
    rewrite ^/products\/Multi\-Effects\/Control2.*$ /en-US/products/control-2 permanent;
    rewrite ^/products\/Multi\-Effects\/RP1000.*$ /en-US/products/rp1000 permanent;
    rewrite ^/products\/Multi\-Effects\/RP500.*$ /en-US/products/rp500 permanent;
    rewrite ^/products\/Multi\-Effects\/RP355.*$ /en-US/products/rp355 permanent;
    rewrite ^/products\/Multi\-Effects\/RP255.*$ /en-US/products/rp255 permanent;
    rewrite ^/products\/Multi\-Effects\/RP155.*$ /en-US/products/rp155 permanent;
    rewrite ^/products\/Multi\-Effects\/RP90.*$ /en-US/products/rp90 permanent;
    rewrite ^/products\/Multi\-Effects\/RP70.*$ /en-US/products/rp70 permanent;
    rewrite ^/products\/Multi\-Effects\/RP55.*$ /en-US/products/rp55 permanent;
    rewrite ^/products\/Pedals\/DeathMetal.*$ /en-US/products/death-metal permanent;
    rewrite ^/products\/Pedals\/Grunge.*$ /en-US/products/grunge permanent;
    rewrite ^/products\/Pedals\/BadMonkey.*$ /en-US/products/bad-monkey permanent;
    rewrite ^/products\/Pedals\/HotHead.*$ /en-US/products/hot-head permanent;
    rewrite ^/products\/Pedals\/Screamin.*$ /en-US/products/screamin'-blues permanent;
    rewrite ^/products\/Pedals\/ToneDriver.*$ /en-US/products/tone-driver permanent;
    rewrite ^/products\/Pedals\/HotRod.*$ /en-US/products/hot-rod permanent;
    rewrite ^/products\/Pedals\/MetalMaster.*$ /en-US/products/metal-master permanent;
    rewrite ^/products\/Pedals\/MainSqueeze.*$ /en-US/products/main-squeeze permanent;
    rewrite ^/products\/Pedals\/MultiChorus.*$ /en-US/products/multi-chorus permanent;
    rewrite ^/products\/Pedals\/TurboFlange.*$ /en-US/products/turbo-flanger permanent;
    rewrite ^/products\/Pedals\/HyperPhase.*$ /en-US/products/hyper-phase permanent;
    rewrite ^/products\/Pedals\/SynthWah.*$ /en-US/products/synth-wah permanent;
    rewrite ^/products\/Pedals\/DigiDelay.*$ /en-US/products/digidelay permanent;
    rewrite ^/products\/Pedals\/DigiVerb.*$ /en-US/products/digiverb permanent;
    rewrite ^/products\/Pedals\/DF7.*$ /en-US/products/df-7-distortion-factory permanent;
    rewrite ^/products\/Pedals\/CF7.*$ /en-US/products/cf-7-chorus-factory permanent;
    rewrite ^/products\/Pedals\/EX7.*$ /en-US/products/ex-7-expression-factory permanent;
    rewrite ^/products\/Pedals\/TimeBender.*$ /en-US/products/timebender permanent;
    rewrite ^/products\/Pedals\/HarmonyMan.*$ /en-US/products/harmonyman permanent;
    rewrite ^/products\/Pedals\/Whammy.*$ /en-US/products/whammy permanent;
    rewrite ^/products\/Pedals\/JamManDelay.*$ /en-US/products/jamman-delay permanent;
    rewrite ^/products\/Pedals\/JamManStereo.*$ /en-US/products/jamman-stereo permanent;
    rewrite ^/products\/Pedals\/JamManSolo.*$ /en-US/products/jamman-solo permanent;
    rewrite ^/products\/Pedals\/JamMan.*$ /en-US/products/jamman permanent;
    rewrite ^/products\/Bass\/BP355.*$ /en-US/products/bp355 permanent;
    rewrite ^/products\/Bass\/BP200.*$ /en-US/products/bp200 permanent;
    rewrite ^/products\/Bass\/BP90.*$ /en-US/products/bp90 permanent;
    rewrite ^/products\/Bass\/BP80.*$ /en-US/products/bp80 permanent;
    rewrite ^/products\/Bass\/BP50.*$ /en-US/products/bp50 permanent;
    rewrite ^/products\/Pedals\/BassChorus.*$ /en-US/products/bass-multi-chorus permanent;
    rewrite ^/products\/Pedals\/BassDriver.*$ /en-US/products/bass-driver permanent;
    rewrite ^/products\/Pedals\/BassSqueeze.*$ /en-US/products/bass-squeeze permanent;
    rewrite ^/products\/Pedals\/BassSynth.*$ /en-US/products/bass-synth-wah permanent;
    rewrite ^/products\/Black13.*$ /en-US/products/scott-ian-black-13 permanent;
    rewrite ^/news.*$ /en-US/news permanent;
    rewrite ^/reviews.*$ /en-US/product_reviews permanent;
    rewrite ^/Reviews.*$ /en-US/product_reviews permanent;
#    rewrite ^/artist.*$ /en-US/artists permanent;
    rewrite ^/software.*$ /en-US/software permanent;
    rewrite ^/flash\/DigiDelay.*$ /en-US/products/digidelay permanent;
    rewrite ^/flash\/DigiVerb.*$ /en-US/products/digiverb permanent;
    rewrite ^/flash\/HotRod.*$ /en-US/products/hot-rod permanent;
    rewrite ^/flash\/HyperPhase.*$ /en-US/products/hyper-phase permanent;
    rewrite ^/flash\/MultiChorus.*$ /en-US/products/multi-chorus permanent;
    rewrite ^/flash\/MetalMaster.*$ /en-US/products/metal-master permanent;
    rewrite ^/flash\/SynthWah.*$ /en-US/products/synth-wah permanent;
    rewrite ^/flash\/ToneDriver.*$ /en-US/products/tone-driver permanent;
    rewrite ^/flash\/DF7.*$ /en-US/products/df-7-distortion-factory permanent;
    rewrite ^/flash\/CF7.*$ /en-US/products/cf-7-chorus-factory permanent;
    rewrite ^/flash\/EX7.*$ /en-US/products/ex-7-expression-factory permanent;
    rewrite ^/Demo_Center\/Video_EX7.*$ /en-US/products/ex-7-expression-factory permanent;
    rewrite ^/flash\/Clapton.*$ /en-US/products/eric-clapton-crossroads permanent;
    rewrite ^/flash\/Black13.*$ /en-US/products/scott-ian-black-13 permanent;
    rewrite ^/flash\/Weapon.*$ /en-US/products/dan-donegan-the-weapon permanent;
    rewrite ^/flash\/BadMonkey.*$ /en-US/products/bad-monkey permanent;
    rewrite ^/flash\/DeathMetal.*$ /en-US/products/death-metal permanent;
    rewrite ^/flash\/Grunge.*$ /en-US/products/grunge permanent;
    rewrite ^/flash\/HotHead.*$ /en-US/products/hot-head permanent;
    rewrite ^/flash\/Screamin.*$ /en-US/products/screamin'-blues permanent;
    rewrite ^/flash\/Whammy.*$ /en-US/products/whammy permanent;
    rewrite ^/flash\/BassChorus.*$ /en-US/products/bass-multi-chorus permanent;
    rewrite ^/flash\/BassDriver.*$ /en-US/products/bass-driver permanent;
    rewrite ^/flash\/BassSqueeze.*$ /en-US/products/bass-squeeze permanent;
    rewrite ^/flash\/BassSynth.*$ /en-US/products/bass-synth-wah permanent;
    rewrite ^/downloads.*$ /en-US/downloads permanent;
    rewrite ^/ToneLibrary.*$ /en-US/tone_library permanent;
    rewrite ^/flash\/Pedal_demos.*$ /en-US/products permanent;
    rewrite ^/SUPPORT.*$ /en-US/support permanent;
#    rewrite ^/ARTISTS.*$ /en-US/artists permanent;
    rewrite ^/rohs.*$ /en-US/rohs permanent;

}


