upstream bss_balancer {
    server 10.10.23.86:8908 weight=3;
    server 10.10.23.15:8908;
}

server {
    listen 10.10.23.86:8908;
    server_name bss_node_1;
    root /var/www/hmg/hsp_websites/current/public;
    passenger_enabled on;
    passenger_use_global_queue on;
}

# This server block will be replaced by the one that follows it
# which is under development.
server {
    listen 10.10.23.52:80;
    server_name www.bssaudio.com 10.10.23.52 "" -;
    include "/etc/nginx/security.conf";
    root /var/www/hmg/bss;
    passenger_enabled off;
    access_log  /var/log/nginx/bss-access.log;
    error_log /var/log/nginx/bss-error.log;
    client_max_body_size 300M; 
    client_body_buffer_size 128k;
    sendfile on;

    # Anything that doesn't start with /training
    # should be proxied to the windows server
    location = /favicon.ico {
      alias /var/www/hmg/hsp_websites/current/public/bss.ico;
    }
    location = /training.php {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location = /training_test.php {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location = /trainingmodules.php {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location ^~ /TrainingModules {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location ^~ /training {
       passenger_enabled on;
       passenger_base_uri /training;
       break;
    }
    location / {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }

}

server {
    listen 10.10.23.88:80;
    server_name bsstest.digitech.com bssaudio.com bssaudious.com www.bss.co.uk www.bssaudio.com www.bssaudious.com;
    include "/etc/nginx/security.conf";
    root /var/www/hmg/hsp_websites/current/public;
    access_log  /var/log/nginx/bss-access.log;
    error_log /var/log/nginx/bss-error.log;
    client_max_body_size 300M; 
    client_body_buffer_size 128k;
    sendfile on;

    location / {
      auth_basic  "Restricted";
      auth_basic_user_file /var/www/hmg/htpasswd;
      passenger_enabled on;
      sendfile on;
    }

# Swap this with previous location when going live
#    location / {
#      proxy_set_header X-Forwarded-Host $host;
#      proxy_set_header X-Forwarded-Server $host;
#      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#      proxy_set_header Host $host;
#      proxy_pass http://bss_balancer;
#    }

    location ~ ^/(assets)/ {
      root /var/www/hmg/hsp_websites/current/public;
      gzip_static on;
      expires modified +24h;
      add_header Cache-Control public;
      add_header ETag "";
      break;
    }
    location ~ ^/(system)/ {
      root /var/www/hmg/hsp_websites/shared;
      gzip_static on;
      expires modified +24h;
      add_header Cache-Control public;
      add_header ETag "";
      break;
    }
    location ~ ^/(swfs)/ {
      root /var/www/hmg/hsp_websites/current/public;
      gzip_static on;
      expires modified +24h;
      add_header Cache-Control public;
      add_header ETag "";
      break;
    }
    # Get rid of lame iframe params
    if ($args ~ (.*)width=[^&]*(.*)) {
      set $args $1$2;
    }
    if ($args ~ (.*)height=[^&]*(.*)) {
      set $args $1$2;
    }
    if ($args ~ (.*)iframe=[^&]*(.*)) {
      set $args $1$2;
    }

    location = /favicon.ico {
      alias /var/www/hmg/hsp_websites/current/public/bss.ico;
    }
    location ^~ /TrainingModules {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location ^~ /training {
      root /var/www/hmg/bss;
      passenger_enabled on;
      passenger_base_uri /training;
      break;
    }
    rewrite ^/training.*\.php$ /training permanent;

    location /mailers/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location /static/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location /phpBB2/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location /product_downloads/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location /Toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }
    location /toolkit/ {
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Server $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host;
      proxy_pass http://10.10.69.172;
    }

    location ^~ /productpg.php {
      if ($args ~ id=2 ) { rewrite ^ /en-US/products/fcs-966?  permanent;  }
      if ($args ~ id=1 ) { rewrite ^ /en-US/products/fcs-960?  permanent;  }
      if ($args ~ id=6 ) { rewrite ^ /en-US/products/fds-366t? permanent;  }
      if ($args ~ id=4 ) { rewrite ^ /en-US/products/fds-334t336t? permanent;}
      if ($args ~ id=72) { rewrite ^ /en-US/products/gs724t?   permanent;  }
      if ($args ~ id=76) { rewrite ^ /en-US/products/blu-805?  permanent;  }
      if ($args ~ id=49) { rewrite ^ /en-US/products/blu-800?  permanent;  }
      if ($args ~ id=43) { rewrite ^ /en-US/products/blu-80?   permanent;  }
      if ($args ~ id=77) { rewrite ^ /en-US/products/blu-325?  permanent;  }
      if ($args ~ id=50) { rewrite ^ /en-US/products/blu-320?  permanent;  }
      if ($args ~ id=41) { rewrite ^ /en-US/products/blu-32?   permanent;  }
      if ($args ~ id=51) { rewrite ^ /en-US/products/blu-160?  permanent;  }
      if ($args ~ id=39) { rewrite ^ /en-US/products/blu-16?   permanent;  }
      if ($args ~ id=52) { rewrite ^ /en-US/products/blu-120?  permanent;  }
      if ($args ~ id=65) { rewrite ^ /en-US/products/blu-100?  permanent;  }
      if ($args ~ id=70) { rewrite ^ /en-US/products/blu-101?  permanent;  }
      if ($args ~ id=71) { rewrite ^ /en-US/products/blu-102?  permanent;  }
      if ($args ~ id=67) { rewrite ^ /en-US/products/blu-bib?  permanent;  }
      if ($args ~ id=61) { rewrite ^ /en-US/products/blu-bob1? permanent;  }
      if ($args ~ id=60) { rewrite ^ /en-US/products/blu-bob2? permanent;  }
      if ($args ~ id=56) { rewrite ^ /en-US/products/blu-10wht?  permanent;}
      if ($args ~ id=55) { rewrite ^ /en-US/products/blu-10blk?  permanent;}
      if ($args ~ id=38) { rewrite ^ /en-US/products/blu-10blu?  permanent;}
      if ($args ~ id=74) { rewrite ^ /en-US/products/blu-8v2wht? permanent;}
      if ($args ~ id=73) { rewrite ^ /en-US/products/blu-8v2blk? permanent;}
      if ($args ~ id=40) { rewrite ^ /en-US/products/blu-3?    permanent;  }
      if ($args ~ id=42) { rewrite ^ /en-US/products/blu-6?    permanent;  }
      if ($args ~ id=57) { rewrite ^ /en-US/products/9012us?   permanent;  }
      if ($args ~ id=58) { rewrite ^ /en-US/products/9015us?   permanent;  }
      if ($args ~ id=68) { rewrite ^ /en-US/products/blu-hif?  permanent;  }
      if ($args ~ id=59) { rewrite ^ /en-US/products/mc-1?     permanent;  }
      if ($args ~ id=69) { rewrite ^ /en-US/products/1u-rack-mount-kit? permanent;}
      if ($args ~ id=17) { rewrite ^ /en-US/products/ar-133?  permanent;   }
      if ($args ~ id=75) { rewrite ^ /en-US/products/usb-to-serial-cable? permanent;}
    }

    location ^~ /discont_productpg.php {
      if ($args ~ id=3 ) { rewrite ^ /en-US/products/fds-310?  permanent; }
      if ($args ~ id=5 ) { rewrite ^ /en-US/products/fds-360?  permanent; }
      if ($args ~ id=9 ) { rewrite ^ /en-US/products/opal-series-dpr-944? permanent; }
      if ($args ~ id=8 ) { rewrite ^ /en-US/products/prosys-ps-8810?  permanent; }
      if ($args ~ id=7 ) { rewrite ^ /en-US/softwares/sb2-control-software-v2-r2-windows-2000-xp?  permanent; }
      if ($args ~ id=19) { rewrite ^ /en-US/products/sw9026?  permanent; }
      if ($args ~ id=20) { rewrite ^ /en-US/products/sw9016?  permanent; }
      if ($args ~ id=21) { rewrite ^ /en-US/products/sw9012?  permanent; }
      if ($args ~ id=22) { rewrite ^ /en-US/products/sw9015?  permanent; }
      if ($args ~ id=23) { rewrite ^ /en-US/products/sw9014?  permanent; }
      if ($args ~ id=24) { rewrite ^ /en-US/products/sw3088?  permanent; }
      if ($args ~ id=25) { rewrite ^ /en-US/products/sw9008iis? permanent; }
      if ($args ~ id=28) { rewrite ^ /en-US/products/sw9000iis? permanent; }
      if ($args ~ id=29) { rewrite ^ /en-US/products/sw9010?  permanent; }
      if ($args ~ id=31) { rewrite ^ /en-US/products/sw9088iis? permanent; }
      if ($args ~ id=16) { rewrite ^ /en-US/products/ar-416?  permanent; }
      if ($args ~ id=18) { rewrite ^ /en-US/products/ar-204?  permanent; }
      if ($args ~ id=45) { rewrite ^ /en-US/products/ar-130?  permanent; }
      if ($args ~ id=46) { rewrite ^ /en-US/products/ar-125?  permanent; }
      if ($args ~ id=10) { rewrite ^ /en-US/products/dpr-901ii? permanent; }
      if ($args ~ id=11) { rewrite ^ /en-US/products/dpr-504?   permanent; }
      if ($args ~ id=12) { rewrite ^ /en-US/products/opal-series-dpr-522? permanent; }
      if ($args ~ id=13) { rewrite ^ /en-US/products/dpr-402?  permanent; }
      if ($args ~ id=14) { rewrite ^ /en-US/products/dpr-404?  permanent; }
      if ($args ~ id=15) { rewrite ^ /en-US/products/opal-series-dpr-422?  permanent; }
      if ($args ~ id=37) { rewrite ^ /en-US/products/fcs-926?  permanent; }
      if ($args ~ id=27) { rewrite ^ /en-US/products/fds-318?  permanent; }
      if ($args ~ id=32) { rewrite ^ /en-US/products/fds-355-omnidrive? permanent; }
      if ($args ~ id=33) { rewrite ^ /en-US/products/fds-388-omnidrive? permanent; }
      if ($args ~ id=34) { rewrite ^ /en-US/products/fds-380-omnidrive? permanent; }
      if ($args ~ id=26) { rewrite ^ /en-US/products/msr-602604ii? permanent; }
      if ($args ~ id=35) { rewrite ^ /en-US/softwares/soundbench-v3-windows? permanent; }
    }

    rewrite ^/conferencing.*$ /en-US/bss-conferencing permanent;
    rewrite ^/News.*$ /en-US/news permanent;
    rewrite ^/news.*$ /en-US/news permanent;

    # Product Families
    rewrite ^/products\.php.*$ /en-US/product_families permanent;
    rewrite ^/ethernet_avb_products.*$ /en-US/product_families/ethernet-avb permanent;
    rewrite ^/soundweb_london.*$ /en-US/product_families/soundweb-london permanent;
    rewrite ^/accessory.*$ /en-US/product_families/accessory-products permanent;
    rewrite ^/discont_products.*$ /en-US/support permanent;
    rewrite ^/equalizers.*$ /en-US/product_families/equalizers--3 permanent;
    rewrite ^/crossovers_loudspeaker.*$ /en-US/product_families/electronic-crossovers-loudspeaker-management permanent;
    rewrite ^/digital_processors.*$ /en-US/support permanent;
    rewrite ^/soundweb\.php.*$ /en-US/support permanent;
    rewrite ^/dynamic_processors.*$ /en-US/support permanent;
    rewrite ^/signal_distribution.*$ /en-US/support permanent;
    rewrite ^/software_applications.*$ /en-US/software permanent;
    rewrite ^/contact_support.*$ /en-US/support permanent;
    rewrite ^/contact_parts.*$ /en-US/support/parts permanent;
    rewrite ^/spare_parts.*$ /en-US/support/parts permanent;
    rewrite ^/contact_repairs.*$ /en-US/support/rma permanent;
    rewrite ^/FAQ.*$ /en-US/support permanent;

    # Other pages
    rewrite ^/aboutsoundweblondon.*$ /en-US/product_families/soundweb-london permanent;
    rewrite ^/aboutsoundweb\.php$ /en-US/support permanent;
    rewrite ^/checking_firmware\.php$ /en-US/soundweb-firmware permanent;
    rewrite ^/Firmware_Wizard.*$ /en-US/software permanent;
    rewrite ^/whiseworks\.php$ /en-US/whiseworks permanent;
    rewrite ^/AEC\_DemoVideo.*$ /en-US/videos permanent;
    rewrite ^/downloads\.php.*$ /en-US/support_downloads permanent;

# Maybe these don't matter anymore. For now, forward to support page
# http://www.bssaudio.com/334_336FirmwareReg.php
# http://www.bssaudio.com/366FirmwareReg.php
    rewrite ^/334_336FirmwareReg.*$ /en-US/support permanent;
    rewrite ^/366FirmwareReg.*$ /en-US/support permanent;

}